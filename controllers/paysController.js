const PaysService = require('../services/paysService');

const PaysController = {
    async createPays(req, res) {
        try {
            const paysData = req.body;
            const pays = await PaysService.createPays(paysData);
            return res.status(200).json({
                success: true,
                message: 'Le pays a √©t√© cr√©√© avec succ√®s',
                data: pays
            });
        } catch (error) {
            return res.status(500).json({ 
                success: false,
                message: error.message 
            });
        }
    },

    // ‚úÖ MODIFI√â : Inclure le total d'√©coles dans la r√©ponse
    async getAllPays(req, res) {
        try {
            const pays = await PaysService.getAllPays();
            
            // Calculer quelques statistiques g√©n√©rales
            const totalPays = pays.length;
            const totalEcoles = pays.reduce((sum, p) => sum + p.totalEcoles, 0);
            const paysAvecEcoles = pays.filter(p => p.totalEcoles > 0).length;
            
            return res.status(200).json({
                success: true,
                message: 'Liste de tous les pays avec le total d\'√©coles',
                data: pays,
                statistiques: {
                    totalPays: totalPays,
                    totalEcoles: totalEcoles,
                    paysAvecEcoles: paysAvecEcoles,
                    paysSansEcoles: totalPays - paysAvecEcoles,
                    moyenneEcolesParPays: totalPays > 0 ? Math.round(totalEcoles / totalPays * 100) / 100 : 0
                }
            });
        } catch (error) {
            return res.status(500).json({ 
                success: false,
                message: error.message 
            });
        }
    },

    // ‚úÖ MODIFI√â : Inclure d√©tails des √©coles pour un pays sp√©cifique
    async getPaysById(req, res) {
        try {
            const paysId = req.params.id;
            const pays = await PaysService.getPaysById(paysId);
            
            if (!pays) {
                return res.status(404).json({ 
                    success: false,
                    message: 'Pays non trouv√©' 
                });
            }
            
            return res.status(200).json({
                success: true,
                message: 'Le pays a √©t√© r√©cup√©r√© avec succ√®s',
                data: pays
            });
        } catch (error) {
            return res.status(500).json({ 
                success: false,
                message: error.message 
            });
        }
    },

    async getPaysByLibelle(req, res) {
        try {
            const { libelle } = req.params;
            const pays = await PaysService.getPaysByLibelle(libelle);
            if (!pays) {
                return res.status(404).json({ 
                    success: false,
                    message: 'Pays non trouv√© avec ce libell√©' 
                });
            }
            return res.status(200).json({
                success: true,
                data: pays
            });
        } catch (error) {
            return res.status(500).json({ 
                success: false,
                message: error.message 
            });
        }
    },

    // ‚úÖ NOUVEAU : Route pour les statistiques d√©taill√©es des pays
    async getPaysStatistiques(req, res) {
        try {
            const statistiques = await PaysService.getPaysStatistiques();
            return res.status(200).json({
                success: true,
                message: 'Statistiques des pays r√©cup√©r√©es avec succ√®s',
                data: statistiques
            });
        } catch (error) {
            return res.status(500).json({ 
                success: false,
                message: error.message 
            });
        }
    },

    // ============================================================================
    // ‚úÖ AM√âLIOR√â : M√©thode updatePays avec meilleure gestion d'erreurs
    // ============================================================================
    async updatePays(req, res) {
        try {
            const paysId = req.params.id;
            const paysData = req.body;

            // Validation de l'ID
            if (!paysId) {
                return res.status(400).json({
                    success: false,
                    message: 'ID du pays requis dans l\'URL'
                });
            }

            // Log pour d√©boguer
            console.log('üîÑ Mise √† jour du pays avec ID:', paysId);
            console.log('üìù Donn√©es re√ßues:', paysData);

            // Validation des donn√©es (optionnel)
            if (paysData.libelle && paysData.libelle.trim() === '') {
                return res.status(400).json({
                    success: false,
                    message: 'Le libell√© du pays ne peut pas √™tre vide'
                });
            }

            const updatedPays = await PaysService.updatePays(paysId, paysData);
            
            console.log('‚úÖ Pays mis √† jour avec succ√®s:', updatedPays);
            
            res.status(200).json({
                success: true,
                message: 'Pays mis √† jour avec succ√®s',
                data: updatedPays
            });
        } catch (err) {
            console.error('‚ùå Erreur lors de la mise √† jour du pays:', err);
            
            // Gestion d'erreurs plus sp√©cifique
            if (err.message.includes('non trouv√©') || err.message.includes('not found')) {
                return res.status(404).json({
                    success: false,
                    message: 'Pays non trouv√©',
                    error: err.message
                });
            }
            
            if (err.message.includes('validation')) {
                return res.status(400).json({
                    success: false,
                    message: 'Donn√©es invalides',
                    error: err.message
                });
            }
            
            res.status(500).json({
                success: false,
                message: 'Erreur lors de la mise √† jour du pays',
                error: err.message
            });
        }
    },

    // ============================================================================
    // ‚úÖ NOUVEAU : M√©thode updatePaysFromBody pour ID dans le body
    // ============================================================================
    async updatePaysFromBody(req, res) {
        try {
            const { id, ...paysData } = req.body; // Extraire l'ID et le reste des donn√©es
            
            // Validation de l'ID
            if (!id) {
                return res.status(400).json({
                    success: false,
                    message: 'ID du pays requis dans le body de la requ√™te'
                });
            }

            // Log pour d√©boguer
            console.log('üîÑ Mise √† jour du pays avec ID (from body):', id);
            console.log('üìù Donn√©es re√ßues:', paysData);

            // Validation des donn√©es
            if (paysData.libelle && paysData.libelle.trim() === '') {
                return res.status(400).json({
                    success: false,
                    message: 'Le libell√© du pays ne peut pas √™tre vide'
                });
            }

            const updatedPays = await PaysService.updatePays(id, paysData);
            
            console.log('‚úÖ Pays mis √† jour avec succ√®s:', updatedPays);
            
            res.status(200).json({
                success: true,
                message: 'Pays mis √† jour avec succ√®s',
                data: updatedPays
            });
        } catch (err) {
            console.error('‚ùå Erreur lors de la mise √† jour du pays:', err);
            
            // Gestion d'erreurs plus sp√©cifique
            if (err.message.includes('non trouv√©') || err.message.includes('not found')) {
                return res.status(404).json({
                    success: false,
                    message: 'Pays non trouv√©',
                    error: err.message
                });
            }
            
            res.status(500).json({
                success: false,
                message: 'Erreur lors de la mise √† jour du pays',
                error: err.message
            });
        }
    },

    // ============================================================================
    // ‚úÖ AM√âLIOR√â : M√©thode deletePaysById avec meilleure gestion d'erreurs
    // ============================================================================
    async deletePaysById(req, res) {
        try {
            const paysId = req.params.id;

            // Validation de l'ID
            if (!paysId) {
                return res.status(400).json({
                    success: false,
                    message: 'ID du pays requis'
                });
            }

            console.log('üóëÔ∏è Suppression du pays avec ID:', paysId);

            await PaysService.deletePaysById(paysId);
            
            console.log('‚úÖ Pays supprim√© avec succ√®s');
            
            res.status(200).json({
                success: true,
                message: 'Pays supprim√© avec succ√®s',
            });
        } catch (err) {
            console.error('‚ùå Erreur lors de la suppression du pays:', err);
            
            // Gestion d'erreurs sp√©cifique
            if (err.message.includes('non trouv√©') || err.message.includes('not found')) {
                return res.status(404).json({
                    success: false,
                    message: 'Pays non trouv√©',
                    error: err.message
                });
            }
            
            if (err.message.includes('√©cole(s) y sont associ√©es')) {
                return res.status(409).json({
                    success: false,
                    message: 'Impossible de supprimer ce pays car des √©coles y sont associ√©es',
                    error: err.message
                });
            }
            
            res.status(500).json({
                success: false,
                message: 'Erreur lors de la suppression du pays',
                error: err.message
            });
        }
    },

    // ============================================================================
    // ‚úÖ NOUVEAU : M√©thodes utilitaires suppl√©mentaires
    // ============================================================================

    /**
     * V√©rifier si un pays existe par son libell√©
     * GET /api/pays/check-libelle/:libelle
     */
    async checkPaysLibelleExists(req, res) {
        try {
            const { libelle } = req.params;
            const pays = await PaysService.getPaysByLibelle(libelle);
            
            return res.status(200).json({
                success: true,
                exists: !!pays,
                data: pays || null
            });
        } catch (error) {
            return res.status(500).json({ 
                success: false,
                message: error.message 
            });
        }
    },

    /**
     * R√©cup√©rer les pays avec leurs √©coles
     * GET /api/pays/avec-ecoles
     */
    async getPaysAvecEcoles(req, res) {
        try {
            const pays = await PaysService.getAllPays();
            const paysAvecEcoles = pays.filter(p => p.totalEcoles > 0);
            
            return res.status(200).json({
                success: true,
                message: 'Liste des pays ayant des √©coles',
                data: paysAvecEcoles,
                total: paysAvecEcoles.length
            });
        } catch (error) {
            return res.status(500).json({ 
                success: false,
                message: error.message 
            });
        }
    }
};

module.exports = PaysController;